"use strict";function shippingAddressContext(n,t,i,r,u,f){function c(n){return r.updateCountry(n,"Shipping").then(function(){n=parseInt(n);var i={};return e.settings.stateProvinceEnabled&&(i.states=r.getStatesByCountryId(n)),t.all(i).then(function(n){if(e.settings.stateProvinceEnabled){e.states=u.prepareStatesModel(n.states.data);var t,i=e.selectedShippingAddress.stateProvince.value,r=o.getLastState().selectedShippingAddress.stateProvince.value;i!=r?t=i:(t=0,e.selectedShippingAddress.stateProvince={});s("StateProvinceId",t)}return o.setState(e),n},function(n){return e=o.getLastState(),t.reject(n)})},function(n){return e=o.getLastState(),t.reject(n)})}function s(n,i){return r.updateAddress(n,i,"shipping").then(function(n){return n},function(n){return t.reject(n)})}function l(i){return n.$broadcast("shippingContextChanging",{initialLoad:i}),r.getCustomerAddresses("Shipping").then(function(t){var f,r,s,h;if(e=t.data,e.selectedShippingAddress={},e.selectedShippingAddress.country={},e.selectedShippingAddress.stateProvince={},e.addresses.length>0){for(f=0;f<e.addresses.length;f++)e.addresses[f].availableCountries=angular.copy(e.availableCountries),e.addresses[f].availableStates=angular.copy(e.availableStatesForNoCountry);r=e.shippingAddress;angular.isDefined(r)?(r.availableCountries=angular.copy(e.availableCountries),s=$.grep(e.addresses,function(n){return n.id===r.id}),s.length>0&&(h=s[0],h.availableStates=angular.copy(r.availableStates)),e.selectedShippingAddress=r,n.$broadcast("defaultAddressSelected",{newShippingAddress:r})):r=angular.copy(e.addresses[0]);e.settings.countryEnabled&&(e.countries=r.availableCountries);e.settings.stateProvinceEnabled&&(e.states=r.availableStates);e.selectedShippingAddress.customAddressAttributes=r.customAddressAttributes;u.equalize(r,e.addresses)}o.setState(e);n.$broadcast("shippingContextChanged",{initialLoad:i})},function(n){return e=o.getLastState(),t.reject(n)})}function a(){return e}function v(i){var r,a,f,v,h,l,y;if(e&&e.selectedShippingAddress){for(a={},f=angular.copy(e.selectedShippingAddress),angular.copy(i,e.selectedShippingAddress),v=0;v<e.persistedShippingAddressFields.length;v++){if(h=e.persistedShippingAddressFields[v],h==="CountryId"&&i.country.value!=f.country.value){l=i.country.value;l&&l.length!=0||(e.states=angular.copy(i.availableStates),l=0);a.newCountryId=l;r||(r={});r.updateCountry=c(l);continue}if(h==="StateProvinceId"&&i.stateProvince.value!=f.stateProvince.value){a.newStateProvinceId=i.stateProvince.value;r||(r={});r.updateStateProvince=s("StateProvinceId",i.stateProvince.value);continue}y=u.uncapitalizeFirstLetter(e.persistedShippingAddressFields[v]);i[y]!=f[y]&&(a["new"+h]=i[y],r||(r={}),r["update"+h]=s(h,i[y]))}angular.isDefined(r)&&n.$broadcast("shippingContextChanging",a);t.all(r).then(function(){for(var h,c,t={},s=0;s<e.persistedShippingAddressFields.length;s++){if(h=e.persistedShippingAddressFields[s],h==="CountryId"&&i.country.value!=f.country.value){t.newCountryId=i.country.value;continue}if(h==="StateProvinceId"&&i.stateProvince.value!=f.stateProvince.value){t.newStateProvinceId=i.stateProvince.value;continue}c=u.uncapitalizeFirstLetter(e.persistedShippingAddressFields[s]);i[c]!=f[c]&&(t["new"+h]=i[c])}angular.isDefined(r)&&n.$broadcast("shippingContextChanged",t);o.setState(e)},function(){e=o.getLastState();n.$broadcast("shippingContextChanged")})}}var h={load:l,get:a,set:v},e,o=f.instance();return h}angular.module("realOnePageCheckout.shippingAddress").factory("shippingAddressContext",shippingAddressContext);shippingAddressContext.$inject=["$rootScope","$q","api","shippingAddressService","objectUtility","stateHolder"];