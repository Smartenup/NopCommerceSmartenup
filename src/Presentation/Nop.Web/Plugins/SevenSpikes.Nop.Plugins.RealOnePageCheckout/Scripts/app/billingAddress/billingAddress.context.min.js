"use strict";function billingAddressContext(n,t,i,r,u,f){function l(n){return r.updateCountry(n,"Billing").then(function(){n=parseInt(n);var i={};return e.settings.stateProvinceEnabled&&(i.states=r.getStatesByCountryId(n)),e.countriesSubjectToVat.indexOf(n)!==-1&&(i.vatNumber=r.checkVatNumber(e.selectedBillingAddress.vat.vatNumber)),t.all(i).then(function(t){if(e.settings.stateProvinceEnabled){e.states=u.prepareStatesModel(t.states.data);var i,r=e.selectedBillingAddress.stateProvince.value,f=o.getLastState().selectedBillingAddress.stateProvince.value;r!=f?i=r:(i=0,e.selectedBillingAddress.stateProvince={});s("StateProvinceId",i)}return e.countriesSubjectToVat.indexOf(n)!==-1&&(e.selectedBillingAddress.vat.vatNumberStatus=t.vatNumber.data.vatNumberStatus),o.setState(e),t},function(n){return e=o.getLastState(),t.reject(n)})},function(n){return e=o.getLastState(),t.reject(n)})}function a(n){return r.checkVatNumber(n).then(function(n){e.selectedBillingAddress.vat.vatNumberStatus=n.data.vatNumberStatus;o.setState(e)},function(n){return t.reject(n)})}function s(n,i){return r.updateAddress(n,i,"billing").then(function(n){return n},function(n){return t.reject(n)})}function v(i){return n.$broadcast("billingContextChanging",{initialLoad:i}),r.getCustomerAddresses("Billing").then(function(t){var f,r,s,h;if(e=t.data,e.selectedBillingAddress={},e.selectedBillingAddress.vat={},e.selectedBillingAddress.country={},e.selectedBillingAddress.stateProvince={},e.addresses.length>0){for(f=0;f<e.addresses.length;f++)e.addresses[f].availableCountries=angular.copy(e.availableCountries),e.addresses[f].availableStates=angular.copy(e.availableStatesForNoCountry);r=e.billingAddress;angular.isDefined(r)?(r.availableCountries=angular.copy(e.availableCountries),s=$.grep(e.addresses,function(n){return n.id===r.id}),s.length>0&&(h=s[0],h.availableStates=angular.copy(r.availableStates)),e.selectedBillingAddress=r,n.$broadcast("defaultAddressSelected",{newBillingAddress:r})):r=angular.copy(e.addresses[0]);e.settings.countryEnabled&&(e.countries=r.availableCountries);e.settings.stateProvinceEnabled&&(e.states=r.availableStates);e.selectedBillingAddress.vat.vatNumber=r.vat.vatNumber;e.selectedBillingAddress.vat.vatNumberStatus=r.vat.vatNumberStatus;e.selectedBillingAddress.customAddressAttributes=r.customAddressAttributes;u.equalize(r,e.addresses)}o.setState(e);n.$broadcast("billingContextChanged",{initialLoad:i})},function(i){return e=o.getLastState(),n.$broadcast("billingContextChanged"),t.reject(i)})}function y(){return e}function p(i){var r,h,f,p,v,y,w;if(e&&e.selectedBillingAddress){for(h={},f=angular.copy(e.selectedBillingAddress),angular.isDefined(i.shipToSameAddress)&&(c=i.shipToSameAddress),angular.copy(i.address,e.selectedBillingAddress),i.address.vat.vatNumber!=f.vat.vatNumber&&(h.newVatNumber=i.address.vat.vatNumber,r||(r={}),r.updateVatNumber=a(i.address.vat.vatNumber)),p=0;p<e.persistedBillingAddressFields.length;p++){if(v=e.persistedBillingAddressFields[p],v==="CountryId"&&i.address.country.value!=f.country.value){y=i.address.country.value;y&&y.length!=0||(e.states=angular.copy(i.address.availableStates),y=0);h.newCountryId=y;r||(r={});r.updateCountry=l(y);continue}if(v==="StateProvinceId"&&i.address.stateProvince.value!=f.stateProvince.value){h.newStateProvinceId=i.address.stateProvince.value;r||(r={});r.updateStateProvince=s("StateProvinceId",i.address.stateProvince.value);continue}w=u.uncapitalizeFirstLetter(e.persistedBillingAddressFields[p]);i.address[w]!=f[w]&&(h["new"+v]=i.address[w],r||(r={}),r["update"+v]=s(v,i.address[w]))}angular.isDefined(r)&&n.$broadcast("billingContextChanging",h);t.all(r).then(function(){var t={},s,h,c;for(i.address.vat.vatNumber!=f.vat.vatNumber&&(t.newVatNumber=i.address.vat.vatNumber),s=0;s<e.persistedBillingAddressFields.length;s++){if(h=e.persistedBillingAddressFields[s],h==="CountryId"&&i.address.country.value!=f.country.value){t.newCountryId=i.address.country.value;continue}if(h==="StateProvinceId"&&i.address.stateProvince.value!=f.stateProvince.value){t.newStateProvinceId=i.address.stateProvince.value;continue}c=u.uncapitalizeFirstLetter(e.persistedBillingAddressFields[s]);i.address[c]!=f[c]&&(t["new"+h]=i.address[c])}angular.isDefined(r)&&n.$broadcast("billingContextChanged",t);o.setState(e);n.$broadcast("shipToSameAddress",{currentBillingAddress:e.selectedBillingAddress,shipToSameAddress:i.shipToSameAddress})},function(r){return e.selectedBillingAddress=o.getLastState(),n.$broadcast("billingContextChanged"),n.$broadcast("shipToSameAddress",{currentBillingAddress:e.selectedBillingAddress,shipToSameAddress:i.shipToSameAddress}),t.reject(r)})}};var h={load:v,get:y,set:p},e,c=!1,o=f.instance();return h}angular.module("realOnePageCheckout.billingAddress").factory("billingAddressContext",billingAddressContext);billingAddressContext.$inject=["$rootScope","$q","api","billingAddressService","objectUtility","stateHolder"];